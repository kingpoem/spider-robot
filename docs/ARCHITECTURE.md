# 系统架构文档

## 概述

本系统是一个基于Arduino和ROS2的蜘蛛型多足机器人控制系统，设计用于在复杂地形中执行农业任务。

## 系统层次结构

```
┌─────────────────────────────────────────────────┐
│           应用层 (ROS2节点)                      │
│  - SLAM节点                                       │
│  - 导航节点                                       │
│  - 任务规划节点                                   │
│  - 步态规划节点                                   │
└──────────────────┬──────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────┐
│        通信层 (ROS2 Bridge)                      │
│  - WiFi/串口通信                                  │
│  - 消息序列化/反序列化                            │
└──────────────────┬──────────────────────────────┘
                   │
┌──────────────────▼──────────────────────────────┐
│        控制层 (Arduino)                           │
│  - 主控制循环                                     │
│  - 步态引擎                                       │
│  - 姿态控制                                       │
│  - 传感器融合                                     │
└──────────────────┬──────────────────────────────┘
                   │
                   │
┌──────────────────▼──────────────────────────────┐
│        硬件驱动层                                 │
│  - 伺服电机驱动                                   │
│  - 传感器接口                                     │
│  - 执行器控制                                     │
└──────────────────────────────────────────────────┘
```

## 核心模块

### 1. Arduino核心模块

#### 1.1 主控制程序 (`hexapod_main.ino`)
- 主控制循环（100Hz）
- 传感器数据更新
- ROS2命令接收
- 步态执行
- 姿态控制

#### 1.2 腿部控制器 (`leg_controller`)
- 伺服电机控制
- 正/逆运动学计算
- 关节角度管理

#### 1.3 传感器接口
- **IMU传感器** (`imu_sensor`): 姿态估计
- **力传感器** (`force_sensor`): 足端接触检测

#### 1.4 步态引擎 (`gait_engine`)
- 基础步态生成（三脚架、波浪、涟漪）
- 步态参数调整
- 姿态调整应用

#### 1.5 ROS2接口 (`ros2_interface`)
- WiFi通信
- 命令接收
- 状态发布

### 2. ROS2节点模块

#### 2.1 SLAM节点 (`hexapod_slam`)
- LiDAR数据处理
- 深度摄像头处理
- 地图构建
- 定位

#### 2.2 导航节点 (`hexapod_navigation`)
- 路径规划
- 路径跟踪
- 速度控制

#### 2.3 任务规划节点 (`hexapod_task_planning`)
- 采摘任务规划
- 收集任务规划
- 监测任务规划
- 灌溉任务规划

#### 2.4 步态规划节点 (`hexapod_gait_planner`)
- DWA算法实现
- 地形适应性分析
- 步态参数调整

### 3. 算法模块

#### 3.1 DWA算法 (`dwa_planner`)
- 动态窗口生成
- 轨迹评估
- 障碍物避让
- 目标跟踪

#### 3.2 地形适应性 (`terrain_adaptation`)
- 坡度分析
- 粗糙度分析
- 可达性分析
- 安全性评分

## 数据流

### 传感器数据流
```
传感器 → Arduino → ROS2节点 → 应用层
```

### 控制命令流
```
应用层 → ROS2节点 → Arduino (Portenta H7) → 执行器
```

## 通信协议

### Arduino ↔ ROS2
- **协议**: 自定义TCP/IP协议（通过WiFi）
- **格式**: 文本协议（可扩展为二进制）
- **频率**: 10-100Hz

## 关键参数

### 机械参数
- 腿部数量: 6
- 每条腿关节数: 3
- 步幅范围: 10-30 cm
- 步高范围: 5-20 cm

### 控制参数
- 控制频率: 100 Hz
- 姿态控制增益: 0.5
- 能量回收阈值: 50 N

### 感知参数
- 地图分辨率: 5 cm/pixel
- 地图大小: 400x400 pixels
- 地形分析半径: 0.5 m

## 扩展性

### 硬件扩展
- 支持更多腿部数量
- 支持更多传感器类型
- 支持模块化腿部更换

### 软件扩展
- 支持更多步态类型
- 支持更多任务类型
- 支持更多算法集成

## 性能指标

### 实时性
- 控制循环延迟: < 10 ms
- 传感器更新延迟: < 20 ms
- ROS2通信延迟: < 50 ms

### 精度
- 位置精度: ± 5 cm
- 姿态精度: ± 2°
- 力传感器精度: ± 1 N

## 安全机制

1. **紧急停止**: 立即停止所有运动
2. **传感器监控**: 实时监控传感器状态
3. **故障检测**: 自动检测硬件故障
4. **超时保护**: 通信超时自动停止

